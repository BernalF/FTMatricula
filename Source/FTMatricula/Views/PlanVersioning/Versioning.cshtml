@{
    Layout = "~/Views/Shared/_LayoutKendo.cshtml";
    ViewBag.Title = Resources.GetValue("PLAN_VERSION");
}

@section styles {

}

<div id="content_edit_left">
    <div class="editMenuSpace">
        <div class="editMenu">
            <ul>
                <li class="editOptList">
                    <div class="editOpt editOptSelected">
                        <a href="#">@Resources.GetValue("PLAN_VERSION")</a>
                    </div>
                </li>
                <li class="editOptList">
                    <div class="editOpt">
                        <a href="@Url.Action("Equivalences", "PlanVersioning")">@Resources.GetValue("EQUIVALENCES")</a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>

<div id="content_edit_right">
    <div class="editBox">
        <div class="editTitle">
            <span>@Resources.GetValue("VERSIONING_ACTION")</span>
        </div>
        <div class="editDetail">
            <div id="LinkPC">
                <ul class="linkPlan">
                    <li class="cWhite">
                        @Html.Label(@Resources.GetValue("PLAN_NAME"))
                    </li>
                    <li>
                        @(Html.Kendo().DropDownList()
                                                    .BindTo(FTMatricula.Utilities.GeneralCollections.PlanList)
                                                    .Name("PlanID")
                                                    .DataTextField("Text")
                                                    .DataValueField("Value")
                                                    .HtmlAttributes(new { @class = "width100" })
                                                    .OptionLabel("Select a Plan"))

                    </li>
                </ul>
                <ul>
                    <li class="padBot10">
                        <a href="#" class="button register" id="btnNewVersion">@Resources.GetValue("NEW_VERSION")</a>
                    </li>
                    <li>
                        <label class="padLeft10 cWhite bold hide" id="lblversion"></label>
                    </li>
                </ul>
                <div class="clear"></div>
                <div class="leftSide marTop10 hide">
                    <h3 class="title2">@Resources.GetValue("UNASSIGNED_COURSE")</h3>
                    <div class="infoHolder">
                        <p class="padLess lined30">@Resources.GetValue("TYPE_AUTO_FILTER")</p>
                        <input id="filter1" class="input" type="text" />
                        <div class="usersHolderBox panel">
                            <ul id="sortable1" class="connectedSortable">
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="rightSide marTop10 hide">
                    <h3 class="title2">@Resources.GetValue("ADDED_COURSES")</h3>
                    <div class="infoHolder">
                        <p class="padLess lined30">@Resources.GetValue("TYPE_AUTO_FILTER")</p>
                        <input id="filter2" class="input" type="text" />
                        <div class="usersHolderBox panel">
                            <ul id="sortable2" class="connectedSortable">
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="clear"></div>
                <ul class="formBtnBar">
                    <li class="hide">
                        <a href="#" class="button send" id="btnLinkPC">Save</a>
                    </li>
                    <li>
                        <a href="@Url.Action("Back", "Home", routeValues: new { opt = "programs" })" class="button back">Cancel</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
    <script type="text/javascript">
        $(function () {
            // Enable drag a drop to the items list
            $('#sortable1, #sortable2').sortable({
                connectWith: '.connectedSortable'
            }).disableSelection();
            filteredList('filter1', 'sortable1');
            filteredList('filter2', 'sortable2');

            // Change event to load 
            $("#PlanID").off('change.PlanID').on('change.PlanID', function () {
                if ($(this).val() != "") {
                    $('#btnNewVersion').off('click.btnNewVersion').on('click.btnNewVersion', function () { GetCoursesbyPlan(); });
                    $('.marTop10').fadeOut();
                    $('.formBtnBar li:first-child').fadeOut();
                    $('#lblversion').fadeOut();
                }
                else {
                    $('#btnNewVersion').off('click.btnNewVersion');
                    $('.marTop10').fadeOut();
                    $('.formBtnBar li:first-child').fadeOut();
                    $('#lblversion').fadeOut();
                }
            });

            function GetCoursesbyPlan() {

                //Generate new Version
                $.bAjax({
                    url: '@Url.Action("GenNewVersion", "PlanVersioning")',
                    ajaxBeforeSend: function () {
                        $('.popupBg').fadeIn();
                        $('.loading').fadeIn();
                    },
                    data: { planID: $('#PlanID').val() },
                    async: false,
                    ajaxSuccess: function (response) {
                        $('#lblversion').html('v.' + response);
                        $('#lblversion').fadeIn();
                    }
                });
                $('.marTop10').fadeIn();
                $('.formBtnBar li:first-child').fadeIn();
                // Get the list of the Courses by Plan
                $.bAjax({
                    url: '@Url.Action("GetCoursesbyPlan", "LinkPC")',
                    data: { planID: $('#PlanID').val() },
                    async: false,
                    ajaxSuccess: function (response) {
                        var result = $.parseJSON(response);
                        if (result.hEnrollment != true) {
                            buildCourseList(result.cUassigned, "#sortable1");
                            buildCourseList(result.cAssigned, "#sortable2");
                            $('#sortable1, #sortable2').sortable("enable");
                            $('.errorsSpace ul li').html('');
                        }
                        else {
                            $('#sortable1, #sortable2').sortable("disable");
                        }
                        $('.popupBg').fadeOut();
                        $('.loading').fadeOut();
                    }
                });
            }

            // Inject the course to the DOM
            function buildCourseList(data, obj) {
                if (data != "") {
                    var content = new StringBuilder();
                    $.each(data, function (key, val) {
                        content.append('<li><span id="');
                        content.append(val.CourseID);
                        content.append('">');
                        content.append(val.Code);
                        content.append(' : ');
                        content.append(val.Name);
                        content.append('</span></li>');
                    });
                    $(obj).html(content.toString());
                }
                else {
                    $(obj).html("");
                }
            }

            // Save Action
            $('#btnLinkPC').off('click.btnLinkPC').on('click.btnLinkPC', function () {
                $.ajaxSettings.traditional = true;
                var lcourses = [];
                $('#sortable2 li').each(function () {
                    lcourses.push($(this).children('span').attr('id'));
                });
                $.bAjax({
                    url: 'LinkPC/InsertPlanCourse',
                    ajaxBeforeSend: function () {
                        $('.popupBg').fadeIn();
                        $('.loading').fadeIn();
                    },
                    data: { planID: $("#PlanID").val(), courses: lcourses },
                    datatype: "json",
                    async: false,
                    ajaxSuccess: function (response) {
                        $('.popupBg').fadeOut();
                        $('.loading').fadeOut();
                        if (response != "true")
                            alert("Please Select a Plan");
                    }
                });
                return false;
            });
        });
    </script>
}